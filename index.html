<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易宝可梦对战 V4.2 (图标显示增强)</title>
    <style>
        /* CSS 样式部分 - 修复 Log 区域溢出和图像拉伸 */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --bg-color: #202020;
            --panel-bg: #f8f8f8;
            --hp-green: #4caf50;
            --hp-yellow: #ffc107;
            --hp-red: #f44336;
        }

        body {
            font-family: 'Press Start 2P', cursive, sans-serif;
            background-color: var(--bg-color);
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            user-select: none;
        }

        #game-container {
            width: 800px;
            height: 600px;
            background-color: var(--panel-bg);
            border: 4px solid #fff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* 标题与选择界面 */
        h1 { text-align: center; font-size: 20px; margin-top: 20px; }
        h2 { font-size: 14px; text-align: center; color: #555; }
        
        #selection-screen {
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }

        .poke-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
        }

        .poke-card {
            background: #eee;
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.1s;
        }
        .poke-card:hover:not(.selected) { transform: scale(1.05); border-color: #00f; }
        .poke-card.selected { border: 3px solid #f00; background: #fff8f8; cursor: default; opacity: 0.7; }
        .poke-card img { width: 60px; height: 60px; image-rendering: pixelated; }

        #start-button {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: none; 
        }
        #start-button:disabled { background: #ccc; }

        /* 战斗界面 */
        #battle-screen {
            display: none; 
            flex-direction: column;
            height: 100%;
        }

        .battle-scene {
            flex: 2;
            background: linear-gradient(to bottom, #87CEEB 50%, #90EE90 50%);
            position: relative;
            display: flex;
            justify-content: space-between;
        }

        .hud {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #333;
            border-radius: 5px;
            padding: 10px;
            width: 250px;
            position: absolute;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.2);
            font-size: 10px;
            z-index: 2; /* 确保 HUD 在精灵上方 */
        }

        .enemy-hud { top: 20px; left: 20px; }
        .player-hud { bottom: 40px; right: 20px; }

        .hp-bar-container {
            width: 100%;
            height: 10px;
            background: #555;
            margin-top: 5px;
            border-radius: 5px;
            overflow: hidden;
        }

        .hp-bar-fill {
            height: 100%;
            background-color: var(--hp-green);
            width: 100%;
            transition: width 0.5s ease-out, background-color 0.3s;
        }

        /* 修复图像拉伸问题 */
        .sprite {
            width: 180px;
            height: 180px;
            position: absolute;
            image-rendering: pixelated;
            object-fit: contain; /* 关键：确保图片不会被拉伸 */
            z-index: 1; /* 确保精灵在 HUD 下方 */
        }

        .enemy-sprite { top: 60px; right: 60px; }
        .player-sprite { bottom: 20px; left: 60px; transform: scaleX(-1); }

        /* 控制台 - 布局优化 */
        .controls {
            flex: 1; 
            background: #333;
            color: white;
            padding: 15px;
            display: flex; 
            gap: 10px;
            min-height: 150px; /* 确保最小高度 */
        }

        .message-box {
            flex: 1.8; /* 增加日志区域比例 */
            height: 100%; 
            box-sizing: border-box; 
            background: #fff;
            color: #000;
            border: 2px solid #888;
            border-radius: 4px;
            padding: 10px;
            font-size: 10px;
            line-height: 1.5;
            overflow-y: auto; 
        }

        .action-grid {
            flex: 1.2; /* 按钮区域占据较少宽度 */
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            font-family: 'Press Start 2P', cursive;
            background: #fff;
            border: 2px solid #aaa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 8px; 
            transition: background 0.1s;
            padding: 5px;
        }
        button:hover:not(:disabled) { background: #eee; border-color: #f00; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-move { border-color: #0000ff; } 
        .btn-action { background: #ffeb3b; border-color: #ff9800; } 
        
        .type-tag {
            font-size: 8px;
            padding: 2px 4px;
            color: white;
            border-radius: 3px;
            margin-right: 2px;
        }

        /* 队伍状态显示 - 核心修复 */
        .team-status {
            position: absolute;
            display: flex;
            gap: 5px;
            z-index: 3; /* 提高 Z-index，确保在 HUD 和精灵之上显示 */
        }
        /* 微调位置以避开 HUD */
        .player-team { bottom: 10px; right: 20px; } 
        .enemy-team { top: 10px; left: 280px; } 

        .team-status .poke-icon {
            width: 30px;
            height: 30px;
            border: 2px solid #555;
            border-radius: 50%;
            /* 关键：确保背景图的显示设置 */
            background-size: 100% 100%; /* 确保图片完整填充圆形区域 */
            background-position: center;
            background-repeat: no-repeat;
            box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); /* 增加阴影，使其更突出 */
            /* 临时背景色，帮助确认元素位置和尺寸是否正常 */
            /* background-color: rgba(255, 0, 0, 0.2); */ 
        }
        .fainted { 
            opacity: 0.4;
            filter: grayscale(100%); /* 倒下时灰度化 */
        }
        .active-poke { border-color: #f00 !important; }

        /* 替换/道具选择界面 */
        #switch-panel, #item-panel, #move-select-panel {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        #switch-panel h2, #item-panel h2, #move-select-panel h2 { color: white; margin-bottom: 20px; }
        .switch-grid {
            display: flex;
            gap: 20px;
        }
        .switch-option {
            background: #fff;
            color: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            width: 120px;
        }
        .switch-option:hover:not(.fainted-switch) { background: #ffc107; }
        .switch-option.fainted-switch { opacity: 0.5; cursor: not-allowed; }

    </style>
</head>
<body>

<div id="game-container">
    <div id="switch-panel">
        <h2>选择要替换上场的宝可梦</h2>
        <div class="switch-grid" id="player-switch-options">
            </div>
    </div>

    <div id="item-panel">
        <h2>选择要使用的道具</h2>
        <div class="switch-grid" id="player-item-options">
            </div>
        <button onclick="hideItemPanel()" style="margin-top: 30px; font-size: 12px; background: #f44336; color: white;">取消</button>
    </div>
    
    <div id="move-select-panel">
        <h2>选择要恢复 PP 的技能</h2>
        <div class="switch-grid" id="move-select-options">
            </div>
        <button onclick="hideMoveSelectPanel()" style="margin-top: 30px; font-size: 12px; background: #f44336; color: white;">取消</button>
    </div>

    <div id="selection-screen">
        <h1>选择你的 3 只宝可梦 (已选: <span id="selected-count">0</span>/3)</h1>
        <h2>点击卡片选择。选择完成后点击下方按钮开始对战。</h2>
        <div class="poke-grid" id="poke-selection-grid">
            </div>
        <button id="start-button" disabled>开始对战</button>
    </div>

    <div id="battle-screen">
        <div class="battle-scene">
            <div class="team-status enemy-team" id="enemy-team-status"></div>
            <div class="team-status player-team" id="player-team-status"></div>

            <div class="hud enemy-hud">
                <div id="enemy-name">???</div>
                <div id="enemy-types"></div>
                <div class="hp-bar-container">
                    <div id="enemy-hp-bar" class="hp-bar-fill"></div>
                </div>
                <small id="enemy-hp-text">100/100</small>
            </div>
            <img id="enemy-img" class="sprite enemy-sprite" src="" alt="Enemy">

            <div class="hud player-hud">
                <div id="player-name">???</div>
                <div id="player-types"></div>
                <div class="hp-bar-container">
                    <div id="player-hp-bar" class="hp-bar-fill"></div>
                </div>
                <small id="player-hp-text">100/100</small>
            </div>
            <img id="player-img" class="sprite player-sprite" src="" alt="Player">
        </div>

        <div class="controls">
            <div class="message-box" id="combat-log">
                欢迎来到宝可梦对战！请选择你的 3 个伙伴。
            </div>
            <div class="action-grid" id="battle-actions">
                </div>
        </div>
    </div>
</div>

<script>
/**
 * 游戏数据与逻辑核心 V4.2 (图标显示增强)
 */

// 1. 属性克制表 (不变)
const TYPE_CHART = {
    normal: { rock: 0.5, ghost: 0, steel: 0.5 }, fire: { fire: 0.5, water: 0.5, grass: 2, ice: 2, bug: 2, rock: 0.5, dragon: 0.5, steel: 2 }, water: { fire: 2, water: 0.5, grass: 0.5, ground: 2, rock: 2, dragon: 0.5 }, electric: { water: 2, electric: 0.5, grass: 0.5, ground: 0, flying: 2, dragon: 0.5 }, grass: { fire: 0.5, water: 2, grass: 0.5, poison: 0.5, ground: 2, flying: 0.5, bug: 0.5, rock: 2, dragon: 0.5, steel: 0.5 }, ice: { fire: 0.5, water: 0.5, grass: 2, ice: 0.5, ground: 2, flying: 2, dragon: 2, steel: 0.5 }, fighting: { normal: 2, ice: 2, rock: 2, dark: 2, steel: 2, poison: 0.5, flying: 0.5, psychic: 0.5, bug: 0.5, ghost: 0, fairy: 0.5 }, poison: { grass: 2, poison: 0.5, ground: 0.5, rock: 0.5, ghost: 0.5, steel: 0, fairy: 2 }, ground: { fire: 2, electric: 2, grass: 0.5, poison: 2, flying: 0, bug: 0.5, rock: 2, steel: 2 }, flying: { electric: 0.5, grass: 2, fighting: 2, bug: 2, rock: 0.5, steel: 0.5 }, psychic: { fighting: 2, poison: 2, psychic: 0.5, dark: 0, steel: 0.5 }, bug: { fire: 0.5, grass: 2, fighting: 0.5, poison: 0.5, flying: 0.5, psychic: 2, ghost: 0.5, dark: 2, steel: 0.5, fairy: 0.5 }, rock: { fire: 2, ice: 2, fighting: 0.5, ground: 0.5, flying: 2, bug: 2, steel: 0.5 }, ghost: { normal: 0, psychic: 2, ghost: 2, dark: 0.5 }, dragon: { dragon: 2, steel: 0.5, fairy: 0 }, steel: { fire: 0.5, water: 0.5, electric: 0.5, ice: 2, rock: 2, steel: 0.5, fairy: 2 }, dark: { fighting: 0.5, psychic: 2, ghost: 2, dark: 0.5, fairy: 0.5 }, fairy: { fire: 0.5, fighting: 2, poison: 0.5, dragon: 2, dark: 2, steel: 0.5 }
};

// 颜色映射 (不变)
const TYPE_COLORS = {
    normal: '#A8A77A', fire: '#EE8130', water: '#6390F0', electric: '#F7D02C', grass: '#7AC74C', ice: '#96D9D6', fighting: '#C22E28', poison: '#A33EA1', ground: '#E2BF65', flying: '#A98FF3', psychic: '#F95587', bug: '#A6B91A', rock: '#B6A136', ghost: '#735797', dragon: '#6F35FC', steel: '#B7B7CE', dark: '#705746', fairy: '#D685AD'
};

// 2. 宝可梦数据库 (使用 PokeAPI 官方图片链接)
const POKEMON_DB = [
    { id: 1, name: "妙蛙花", types: ["grass", "poison"], hp: 360, stats: { atk: 182, def: 183 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/3.png", moves: [{ name: "藤鞭", type: "grass", power: 45, maxPp: 20 }, { name: "污泥炸弹", type: "poison", power: 90, maxPp: 10 }, { name: "地震", type: "ground", power: 100, maxPp: 10 }, { name: "撞击", type: "normal", power: 40, maxPp: 30 }] },
    { id: 2, name: "喷火龙", types: ["fire", "flying"], hp: 356, stats: { atk: 204, def: 158 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/6.png", moves: [{ name: "喷射火焰", type: "fire", power: 90, maxPp: 15 }, { name: "空气斩", type: "flying", power: 75, maxPp: 15 }, { name: "龙爪", type: "dragon", power: 80, maxPp: 15 }, { name: "大字爆炎", type: "fire", power: 110, maxPp: 5 }] },
    { id: 3, name: "水箭龟", types: ["water"], hp: 362, stats: { atk: 171, def: 200 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/9.png", moves: [{ name: "水炮", type: "water", power: 110, maxPp: 5 }, { name: "咬碎", type: "dark", power: 80, maxPp: 15 }, { name: "急冻光线", type: "ice", power: 90, maxPp: 10 }, { name: "高速旋转", type: "normal", power: 50, maxPp: 40 }] },
    { id: 4, name: "皮卡丘", types: ["electric"], hp: 250, stats: { atk: 180, def: 100 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png", moves: [{ name: "十万伏特", type: "electric", power: 90, maxPp: 15 }, { name: "电光一闪", type: "normal", power: 40, maxPp: 30 }, { name: "铁尾", type: "steel", power: 100, maxPp: 15 }, { name: "打雷", type: "electric", power: 110, maxPp: 10 }] },
    { id: 5, name: "耿鬼", types: ["ghost", "poison"], hp: 290, stats: { atk: 230, def: 130 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/94.png", moves: [{ name: "暗影球", type: "ghost", power: 80, maxPp: 15 }, { name: "污泥波", type: "poison", power: 95, maxPp: 10 }, { name: "魔法闪耀", type: "fairy", power: 80, maxPp: 10 }, { name: "十万伏特", type: "electric", power: 90, maxPp: 15 }] },
    { id: 6, name: "怪力", types: ["fighting"], hp: 380, stats: { atk: 230, def: 160 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/68.png", moves: [{ name: "爆裂拳", type: "fighting", power: 100, maxPp: 5 }, { name: "雷电拳", type: "electric", power: 75, maxPp: 15 }, { name: "尖石攻击", type: "rock", power: 100, maxPp: 5 }, { name: "二连劈", type: "dragon", power: 40, maxPp: 30 }] },
    { id: 7, name: "胡地", types: ["psychic"], hp: 280, stats: { atk: 240, def: 110 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/65.png", moves: [{ name: "精神强念", type: "psychic", power: 90, maxPp: 10 }, { name: "真气弹", type: "fighting", power: 120, maxPp: 5 }, { name: "暗影球", type: "ghost", power: 80, maxPp: 15 }, { name: "能量球", type: "grass", power: 90, maxPp: 10 }] },
    { id: 8, name: "快龙", types: ["dragon", "flying"], hp: 386, stats: { atk: 234, def: 180 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/149.png", moves: [{ name: "逆鳞", type: "dragon", power: 120, maxPp: 10 }, { name: "神速", type: "normal", power: 80, maxPp: 5 }, { name: "火焰拳", type: "fire", power: 75, maxPp: 15 }, { name: "飞翔", type: "flying", power: 90, maxPp: 15 }] },
    { id: 9, name: "巨钳螳螂", types: ["bug", "steel"], hp: 340, stats: { atk: 230, def: 200 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/212.png", moves: [{ name: "子弹拳", type: "steel", power: 40, maxPp: 30 }, { name: "十字剪", type: "bug", power: 80, maxPp: 15 }, { name: "燕返", type: "flying", power: 60, maxPp: 20 }, { name: "暗袭要害", type: "dark", power: 70, maxPp: 15 }] },
    { id: 10, name: "班基拉斯", types: ["rock", "dark"], hp: 400, stats: { atk: 234, def: 200 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/248.png", moves: [{ name: "岩崩", type: "rock", power: 75, maxPp: 10 }, { name: "咬碎", type: "dark", power: 80, maxPp: 15 }, { name: "地震", type: "ground", power: 100, maxPp: 10 }, { name: "冰牙", type: "ice", power: 65, maxPp: 15 }] },
    { id: 11, name: "沙奈朵", types: ["psychic", "fairy"], hp: 336, stats: { atk: 225, def: 145 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/282.png", moves: [{ name: "月亮之力", type: "fairy", power: 95, maxPp: 15 }, { name: "精神强念", type: "psychic", power: 90, maxPp: 10 }, { name: "十万伏特", type: "electric", power: 90, maxPp: 15 }, { name: "能量球", type: "grass", power: 90, maxPp: 10 }] },
    { id: 12, name: "路卡利欧", types: ["fighting", "steel"], hp: 310, stats: { atk: 210, def: 140 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/448.png", moves: [{ name: "波导弹", type: "fighting", power: 80, maxPp: 20 }, { name: "加农光炮", type: "steel", power: 80, maxPp: 15 }, { name: "神速", type: "normal", power: 80, maxPp: 5 }, { name: "骨棒乱打", type: "ground", power: 25, maxPp: 10 }] },
    { id: 13, name: "烈咬陆鲨", types: ["dragon", "ground"], hp: 416, stats: { atk: 230, def: 180 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/445.png", moves: [{ name: "地震", type: "ground", power: 100, maxPp: 10 }, { name: "龙爪", type: "dragon", power: 80, maxPp: 15 }, { name: "尖石攻击", type: "rock", power: 100, maxPp: 5 }, { name: "铁头", type: "steel", power: 80, maxPp: 15 }] },
    { id: 14, name: "甲贺忍蛙", types: ["water", "dark"], hp: 314, stats: { atk: 200, def: 140 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/658.png", moves: [{ name: "手里剑", type: "water", power: 20, maxPp: 30 }, { name: "暗袭要害", type: "dark", power: 70, maxPp: 15 }, { name: "神通力", type: "psychic", power: 80, maxPp: 10 }, { name: "急冻光线", type: "ice", power: 90, maxPp: 10 }] },
    { id: 15, name: "基拉祈", types: ["steel", "psychic"], hp: 360, stats: { atk: 200, def: 200 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/385.png", moves: [{ name: "破灭之愿", type: "steel", power: 140, maxPp: 5 }, { name: "精神强念", type: "psychic", power: 90, maxPp: 10 }, { name: "魔法闪耀", type: "fairy", power: 80, maxPp: 10 }, { name: "十万伏特", type: "electric", power: 90, maxPp: 15 }] },
    { id: 16, name: "梦幻", types: ["psychic"], hp: 400, stats: { atk: 200, def: 200 }, img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/151.png", moves: [{ name: "精神强念", type: "psychic", power: 90, maxPp: 10 }, { name: "波导弹", type: "fighting", power: 80, maxPp: 20 }, { name: "喷射火焰", type: "fire", power: 90, maxPp: 15 }, { name: "冲浪", type: "water", power: 90, maxPp: 15 }] }
];

// 3. 道具数据库 (新增 以太)
const ITEM_DB = [
    { name: "伤药", effect: "恢复 50 HP", heal: 50, quantity: 3 }, 
    { name: "以太", effect: "恢复 1 个技能的 10 PP", recoverPp: 10, quantity: 2 } 
];


/**
 * 游戏状态管理
 */
let gameState = {
    playerTeam: [],
    enemyTeam: [],
    playerActiveIndex: 0, 
    enemyActiveIndex: 0,
    playerItems: JSON.parse(JSON.stringify(ITEM_DB)),
    isPlayerTurn: true,
    isGameOver: false,
    selectedPokes: [],
    activeItemForPP: null, 
};

// DOM 元素引用
const selectionScreen = document.getElementById('selection-screen');
const battleScreen = document.getElementById('battle-screen');
const selectionGrid = document.getElementById('poke-selection-grid');
const startButton = document.getElementById('start-button');
const selectedCountSpan = document.getElementById('selected-count');
const combatLog = document.getElementById('combat-log');
const battleActionsContainer = document.getElementById('battle-actions');
const switchPanel = document.getElementById('switch-panel');
const playerSwitchOptions = document.getElementById('player-switch-options');
const itemPanel = document.getElementById('item-panel');
const playerItemOptions = document.getElementById('player-item-options');
const moveSelectPanel = document.getElementById('move-select-panel'); 
const moveSelectOptions = document.getElementById('move-select-options'); 


// 获取当前上场的宝可梦对象 (辅助函数)
const getPlayerActive = () => gameState.playerTeam[gameState.playerActiveIndex];
const getEnemyActive = () => gameState.enemyTeam[gameState.enemyActiveIndex];


// ----------------------------------------------------
// 辅助函数 (不变)
// ----------------------------------------------------

// 渲染属性标签 
function renderTypeTags(types) {
    return types.map(t => 
        `<span class="type-tag" style="background:${TYPE_COLORS[t]}">${t.toUpperCase()}</span>`
    ).join('');
}

// 伤害计算辅助函数 (略)
function getTypeEffectiveness(moveType, targetTypes) {
    let multiplier = 1;
    if (!TYPE_CHART[moveType]) return 1;

    targetTypes.forEach(targetType => {
        if (TYPE_CHART[moveType][targetType] !== undefined) {
            multiplier *= TYPE_CHART[moveType][targetType];
        }
    });
    return multiplier;
}

function calculateDamage(move, attacker, defender) {
    const level = 50;
    const atk = attacker.stats.atk;
    const def = defender.stats.def;
    
    let damage = (((2 * level / 5 + 2) * move.power * atk / def) / 50) + 2;

    if (attacker.types.includes(move.type)) {
        damage *= 1.5;
    }

    const typeMult = getTypeEffectiveness(move.type, defender.types);
    damage *= typeMult;

    damage *= (Math.random() * 0.15 + 0.85);

    return {
        damage: Math.floor(damage),
        multiplier: typeMult
    };
}

// UI 辅助函数
function getHpColor(pct) {
    if (pct > 50) return 'var(--hp-green)';
    if (pct > 20) return 'var(--hp-yellow)';
    return 'var(--hp-red)';
}

function updateHealthUI() {
    const playerActive = getPlayerActive();
    const enemyActive = getEnemyActive();
    
    const playerPct = Math.max(0, (playerActive.currentHp / playerActive.poke.hp) * 100);
    const enemyPct = Math.max(0, (enemyActive.currentHp / enemyActive.poke.hp) * 100);

    const playerBar = document.getElementById('player-hp-bar');
    const enemyBar = document.getElementById('enemy-hp-bar');

    playerBar.style.width = `${playerPct}%`;
    playerBar.style.backgroundColor = getHpColor(playerPct);
    
    enemyBar.style.width = `${enemyPct}%`;
    enemyBar.style.backgroundColor = getHpColor(enemyPct);

    document.getElementById('player-hp-text').innerText = `${Math.ceil(playerActive.currentHp)}/${playerActive.poke.hp}`;
    document.getElementById('enemy-hp-text').innerText = `${Math.ceil(enemyActive.currentHp)}/${enemyActive.poke.hp}`;
}

function log(msg) {
    const p = document.createElement('div');
    p.innerHTML = `> ${msg}`;
    combatLog.appendChild(p);
    combatLog.scrollTop = combatLog.scrollHeight;
}

function toggleButtons(enable) {
    const btns = battleActionsContainer.querySelectorAll('button');
    btns.forEach(b => b.disabled = !enable);
}

// Move PP 初始化函数
function initializeMoves(moves) {
    return moves.map(move => ({
        ...move,
        currentPp: move.maxPp 
    }));
}

// ----------------------------------------------------
// 队伍状态渲染 - 核心代码
// ----------------------------------------------------
function renderTeamStatus() {
    const renderIcons = (team, containerId, activeIndex) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        team.forEach((item, index) => {
            const icon = document.createElement('div');
            icon.className = 'poke-icon';
            
            // 确保背景图路径正确且能加载
            // 使用 CSS background-image 加载宝可梦头像
            icon.style.backgroundImage = `url(${item.poke.img})`;

            if (item.isFainted) {
                icon.classList.add('fainted');
            } else {
                 icon.classList.remove('fainted');
            }
            if (index === activeIndex) {
                icon.classList.add('active-poke');
            } else {
                icon.classList.remove('active-poke');
            }
            container.appendChild(icon);
        });
    };

    renderIcons(gameState.enemyTeam, 'enemy-team-status', gameState.enemyActiveIndex);
    renderIcons(gameState.playerTeam, 'player-team-status', gameState.playerActiveIndex);
}


// ----------------------------------------------------
// 主游戏流程函数 (不变)
// ----------------------------------------------------

// 初始化选择界面 (不变)
function init() {
    POKEMON_DB.forEach((poke, index) => {
        const card = document.createElement('div');
        card.className = 'poke-card';
        card.id = `poke-card-${index}`;
        card.innerHTML = `
            <img src="${poke.img}" alt="${poke.name}">
            <div>${poke.name}</div>
            <div style="font-size:8px;color:#666;">
                ${renderTypeTags(poke.types)}
            </div>
        `;
        card.onclick = () => selectPokemon(poke, card);
        selectionGrid.appendChild(card);
    });
    startButton.onclick = startGame;
}

// 宝可梦选择逻辑 (不变)
function selectPokemon(poke, card) {
    if (gameState.selectedPokes.includes(poke)) {
        gameState.selectedPokes = gameState.selectedPokes.filter(p => p !== poke);
        card.classList.remove('selected');
    } else if (gameState.selectedPokes.length < 3) {
        gameState.selectedPokes.push(poke);
        card.classList.add('selected');
    }
    
    selectedCountSpan.innerText = gameState.selectedPokes.length;
    startButton.disabled = gameState.selectedPokes.length !== 3;
    if (gameState.selectedPokes.length === 3) {
        startButton.style.display = 'block';
    } else {
        startButton.style.display = 'none';
    }
}

// 开始游戏 (不变)
function startGame() {
    if (gameState.selectedPokes.length !== 3) return;

    // 1. 设置玩家队伍
    gameState.playerTeam = gameState.selectedPokes.map(p => ({
        poke: {
            ...p, 
            moves: initializeMoves(p.moves) 
        },
        currentHp: p.hp,
        isFainted: false
    }));

    // 2. 随机设置机器人队伍
    const playerIds = gameState.playerTeam.map(item => item.poke.id);
    let availablePokes = POKEMON_DB.filter(p => !playerIds.includes(p.id));
    
    const enemyPokes = [];
    while (enemyPokes.length < 3 && availablePokes.length > 0) {
        const randomIndex = Math.floor(Math.random() * availablePokes.length);
        enemyPokes.push(availablePokes[randomIndex]);
        availablePokes.splice(randomIndex, 1); 
    }

    gameState.enemyTeam = enemyPokes.map(p => ({
        poke: {
            ...p,
            moves: initializeMoves(p.moves) 
        },
        currentHp: p.hp,
        isFainted: false
    }));

    gameState.playerActiveIndex = 0;
    gameState.enemyActiveIndex = 0;
    gameState.isPlayerTurn = true;

    // 3. UI 切换
    selectionScreen.style.display = 'none';
    battleScreen.style.display = 'flex';
    
    setupBattleUI();
    log(`你选择了 ${gameState.playerTeam.map(i => i.poke.name).join('、')}！`);
    log(`对手是 ${gameState.enemyTeam.map(i => i.poke.name).join('、')}！`);
    log(`去吧，${gameState.playerTeam[0].poke.name}！`);
}

// 渲染战斗UI 
function setupBattleUI() {
    const playerActive = getPlayerActive();
    const enemyActive = getEnemyActive();

    document.getElementById('player-img').src = playerActive.poke.img;
    document.getElementById('enemy-img').src = enemyActive.poke.img;
    
    document.getElementById('player-name').innerText = playerActive.poke.name;
    document.getElementById('enemy-name').innerText = enemyActive.poke.name;

    document.getElementById('player-types').innerHTML = renderTypeTags(playerActive.poke.types);
    document.getElementById('enemy-types').innerHTML = renderTypeTags(enemyActive.poke.types);

    updateHealthUI();
    renderTeamStatus(); 
    renderBattleActions();
}


// 渲染战斗操作按钮 (技能/替换/道具) (不变)
function renderBattleActions() {
    battleActionsContainer.innerHTML = '';
    const playerActive = getPlayerActive();

    // 1. 技能按钮
    playerActive.poke.moves.forEach((move, index) => {
        const btn = document.createElement('button');
        btn.className = 'btn-move';
        // 显示当前 PP / 最大 PP
        btn.innerHTML = `${move.name}<br><small>${move.type} (${move.currentPp}/${move.maxPp})</small>`; 
        
        btn.disabled = move.currentPp <= 0; // PP 耗尽则禁用
        btn.onclick = () => playerMove(index); // 传递索引
        
        battleActionsContainer.appendChild(btn);
    });

    // 2. 道具按钮
    const potion = gameState.playerItems.find(i => i.name === "伤药");
    const ether = gameState.playerItems.find(i => i.name === "以太");
    
    // 伤药按钮
    const potionBtn = document.createElement('button');
    potionBtn.className = 'btn-action';
    potionBtn.innerHTML = `伤药 (x${potion.quantity})`;
    potionBtn.disabled = potion.quantity <= 0;
    potionBtn.onclick = () => showItemPanel(); // 先打开道具面板
    battleActionsContainer.appendChild(potionBtn);
    
    // 以太按钮
    const etherBtn = document.createElement('button');
    etherBtn.className = 'btn-action';
    etherBtn.innerHTML = `以太 (x${ether.quantity})`;
    etherBtn.disabled = ether.quantity <= 0;
    etherBtn.onclick = () => showItemPanel(); // 先打开道具面板
    battleActionsContainer.appendChild(etherBtn);

    // 3. 替换按钮
    const switchBtn = document.createElement('button');
    switchBtn.className = 'btn-action';
    switchBtn.innerText = "替换";
    const availableSwitches = gameState.playerTeam.filter((item, index) => 
        !item.isFainted && index !== gameState.playerActiveIndex
    );
    switchBtn.disabled = availableSwitches.length === 0;
    switchBtn.onclick = showSwitchPanel;
    battleActionsContainer.appendChild(switchBtn);
}


// 玩家回合: 攻击 (不变)
function playerMove(moveIndex) {
    if (!gameState.isPlayerTurn || gameState.isGameOver) return;
    
    const playerActive = getPlayerActive();
    const move = playerActive.poke.moves[moveIndex]; 
    
    if (move.currentPp <= 0) {
        log(`** ${move.name} ** 的 PP 已经用完了！请使用其他技能或替换。`);
        return; 
    }

    toggleButtons(false);
    
    move.currentPp--; 
    renderBattleActions(); 

    const enemyActive = getEnemyActive();

    processTurn(playerActive.poke, enemyActive.poke, move, true, () => {
        if (enemyActive.isFainted) {
            checkWinCondition();
            if (!gameState.isGameOver) {
                botForcedSwitch(); 
            }
        }
        if (!gameState.isGameOver) {
            gameState.isPlayerTurn = false;
            botTurn();
        }
    });
}


// 玩家回合: 使用道具 (不变)
function useItem(item) {
    if (!gameState.isPlayerTurn || gameState.isGameOver) return;
    
    if (item.name === "伤药") {
        hideItemPanel();
        toggleButtons(false);

        const playerActive = getPlayerActive();
        const healAmount = item.heal;
        const newHp = Math.min(playerActive.poke.hp, playerActive.currentHp + healAmount);
        const actualHeal = newHp - playerActive.currentHp;
        
        playerActive.currentHp = newHp;
        
        const potion = gameState.playerItems.find(i => i.name === "伤药");
        potion.quantity--;

        updateHealthUI();
        log(`${playerActive.poke.name} 使用了 **${item.name}**，恢复了 ${actualHeal} 点 HP！ (剩余: x${potion.quantity})`);

        // 结束回合
        gameState.isPlayerTurn = false;
        setTimeout(botTurn, 1000);
        
    } else if (item.name === "以太") {
        const ether = gameState.playerItems.find(i => i.name === "以太");
        // 检查是否有 PP 可以恢复
        const hasPpToRestore = getPlayerActive().poke.moves.some(m => m.currentPp < m.maxPp);
        
        if (!hasPpToRestore) {
             log(`** ${getPlayerActive().poke.name} ** 的所有技能 PP 都是满的，无法使用 ${item.name}！`);
             // 不消耗道具，不结束回合
             hideItemPanel();
             return; 
        }
        
        // 标记当前使用的道具，并打开技能选择面板
        gameState.activeItemForPP = item; 
        showMoveSelectPanel();
    }
}

// ----------------------------------------------------
// PP 恢复逻辑 (不变)
// ----------------------------------------------------

function showMoveSelectPanel() {
    itemPanel.style.display = 'none'; 
    moveSelectPanel.style.display = 'flex';
    moveSelectOptions.innerHTML = '';

    const playerActive = getPlayerActive();
    const item = gameState.activeItemForPP;
    
    playerActive.poke.moves.forEach((move, index) => {
        const option = document.createElement('div');
        option.className = 'switch-option';
        option.innerHTML = `
            <div>**${move.name}**</div>
            <div style="font-size:10px;">PP: ${move.currentPp}/${move.maxPp}</div>
        `;
        
        // 只有 PP 未满的才能点击
        if (move.currentPp < move.maxPp) {
            option.onclick = () => useEtherOnMove(item, index);
        } else {
            option.classList.add('fainted-switch');
            option.onclick = () => log("该技能 PP 已满。");
        }
        moveSelectOptions.appendChild(option);
    });
}

function hideMoveSelectPanel() {
    moveSelectPanel.style.display = 'none';
    gameState.activeItemForPP = null; 
    if (gameState.isPlayerTurn && !gameState.isGameOver) {
         toggleButtons(true);
    }
}

function useEtherOnMove(item, moveIndex) {
    hideMoveSelectPanel();
    toggleButtons(false);

    const playerActive = getPlayerActive();
    const move = playerActive.poke.moves[moveIndex];
    const itemData = gameState.playerItems.find(i => i.name === item.name);

    const recoverAmount = item.recoverPp;
    const newPp = Math.min(move.maxPp, move.currentPp + recoverAmount);
    const actualRecover = newPp - move.currentPp;
    
    move.currentPp = newPp;
    itemData.quantity--;

    log(`${playerActive.poke.name} 对 **${move.name}** 使用了 **${item.name}**，恢复了 ${actualRecover} 点 PP！ (剩余: x${itemData.quantity})`);
    
    renderBattleActions(); 

    // 结束回合
    gameState.isPlayerTurn = false;
    setTimeout(botTurn, 1000);
}


// ----------------------------------------------------
// 机器人回合逻辑 (不变)
// ----------------------------------------------------

function botTurn() {
    if (gameState.isGameOver) return;

    const enemyActive = getEnemyActive();
    if (enemyActive.isFainted) {
        botForcedSwitch();
        return;
    }
    
    setTimeout(() => {
        // 1. 筛选出 PP 大于 0 的技能
        const availableMoves = enemyActive.poke.moves.filter(m => m.currentPp > 0);
        
        if (availableMoves.length === 0) {
             // 机器人所有技能 PP 耗尽，只能跳过回合
            log(`${enemyActive.poke.name} 的所有技能 PP 都用完了，它无法行动！`);
            gameState.isPlayerTurn = true;
            renderBattleActions();
            toggleButtons(true);
            return;
        }
        
        // 2. 随机选择一个可用技能
        const randomIndex = Math.floor(Math.random() * availableMoves.length);
        const randomMove = availableMoves[randomIndex];
        
        // 3. 消耗 PP
        const moveIndexInFullList = enemyActive.poke.moves.findIndex(m => m === randomMove);
        enemyActive.poke.moves[moveIndexInFullList].currentPp--;
        
        processTurn(enemyActive.poke, getPlayerActive().poke, randomMove, false, () => {
            if (getPlayerActive().isFainted) {
                checkWinCondition();
                if (!gameState.isGameOver) {
                    playerForcedSwitch();
                }
            }
            if (!gameState.isGameOver) {
                gameState.isPlayerTurn = true;
                renderBattleActions(); 
                toggleButtons(true);
            }
        });
    }, 1500);
}


// 通用伤害处理流程 (不变)
function processTurn(attackerData, defenderData, move, isPlayerAttacking, callback) {
    const attacker = isPlayerAttacking ? getPlayerActive() : getEnemyActive();
    const defender = isPlayerAttacking ? getEnemyActive() : getPlayerActive();

    const result = calculateDamage(move, attackerData, defenderData);
    
    defender.currentHp = Math.max(0, defender.currentHp - result.damage);
    if (defender.currentHp <= 0) {
        defender.isFainted = true;
        log(`${defender.poke.name} 倒下了！`);
    }
    
    updateHealthUI();
    renderTeamStatus();

    let effectText = "";
    if (result.multiplier >= 2) effectText = "效果绝佳！";
    if (result.multiplier <= 0.5 && result.multiplier > 0) effectText = "效果不理想...";
    if (result.multiplier === 0) effectText = "好像没有效果...";

    log(`${attackerData.name} 使用了 **${move.name}**！${effectText} (造成 ${result.damage} 点伤害)`);
    
    setTimeout(callback, 1000);
}

// ----------------------------------------------------
// 替换/结束逻辑 (不变)
// ----------------------------------------------------

function showSwitchPanel() {
    switchPanel.style.display = 'flex';
    playerSwitchOptions.innerHTML = '';
    document.querySelector('#switch-panel h2').innerText = "选择要替换上场的宝可梦";

    gameState.playerTeam.forEach((item, index) => {
        const option = document.createElement('div');
        option.className = 'switch-option';
        option.innerHTML = `
            <img src="${item.poke.img}" style="width:50px; height:50px; image-rendering:pixelated;">
            <div>${item.poke.name}</div>
            <div style="font-size:10px;">HP: ${Math.ceil(item.currentHp)}/${item.poke.hp}</div>
        `;

        if (item.isFainted || index === gameState.playerActiveIndex) {
            option.classList.add('fainted-switch');
            if (item.isFainted) {
                 option.onclick = () => log("该宝可梦已经失去了战斗能力！");
            } else if (index === gameState.playerActiveIndex) {
                 option.onclick = () => log("该宝可梦已经在场上了！");
            }
        } else {
            option.onclick = () => playerSwitch(index);
        }
        playerSwitchOptions.appendChild(option);
    });
}

function hideSwitchPanel() {
    switchPanel.style.display = 'none';
}

function showItemPanel() {
    itemPanel.style.display = 'flex';
    playerItemOptions.innerHTML = '';

    gameState.playerItems.forEach(item => {
        const option = document.createElement('div');
        option.className = 'switch-option';
        option.style.backgroundColor = item.quantity > 0 ? '#b3ffb3' : '#eee';
        
        let subText = item.effect;
        if (item.name === "以太") {
             const hasPpToRestore = getPlayerActive().poke.moves.some(m => m.currentPp < m.maxPp);
             if (!hasPpToRestore) {
                subText = '（所有技能 PP 已满）';
             }
        }
        
        option.innerHTML = `
            <h3>${item.name} x${item.quantity}</h3>
            <div>${subText}</div>
        `;
        
        if (item.quantity > 0) {
            option.onclick = () => useItem(item);
        } else {
            option.classList.add('fainted-switch');
        }
        playerItemOptions.appendChild(option);
    });
}

function hideItemPanel() {
    itemPanel.style.display = 'none';
    // 如果取消使用道具，重新启用按钮
    toggleButtons(true);
}


function playerSwitch(newIndex) {
    if (!gameState.isPlayerTurn || gameState.isGameOver) return;
    
    hideSwitchPanel();
    toggleButtons(false);

    const oldPoke = getPlayerActive();
    const newPoke = gameState.playerTeam[newIndex];

    gameState.playerActiveIndex = newIndex;
    setupBattleUI();
    
    log(`玩家将 ${oldPoke.poke.name} 收回，换上了 **${newPoke.poke.name}**！`);

    gameState.isPlayerTurn = false;
    setTimeout(botTurn, 1000);
}

function playerForcedSwitch() {
    log(`** ${getPlayerActive().poke.name} 倒下了！请选择下一只宝可梦！ **`);
    const available = gameState.playerTeam.filter(item => !item.isFainted);
    if (available.length > 0) {
        showForcedSwitchPanel(gameState.playerTeam, (newIndex) => {
            gameState.playerActiveIndex = newIndex;
            setupBattleUI();
            log(`** 去吧，${getPlayerActive().poke.name}！ **`);
            gameState.isPlayerTurn = true;
            renderBattleActions();
            toggleButtons(true);
            hideSwitchPanel();
        });
    }
}

function botForcedSwitch() {
    log(`** ${getEnemyActive().poke.name} 倒下了！对手正在替换！ **`);
    const availableIndices = gameState.enemyTeam
        .map((item, index) => ({ item, index }))
        .filter(entry => !entry.item.isFainted);

    if (availableIndices.length > 0) {
        // 机器人随机选择一只未倒下的宝可梦
        const randomIndex = Math.floor(Math.random() * availableIndices.length);
        const newIndex = availableIndices[randomIndex].index;
        
        gameState.enemyActiveIndex = newIndex;
        setupBattleUI();
        log(`对手派出了 **${getEnemyActive().poke.name}**！`);
        // 替换后轮到玩家行动
        gameState.isPlayerTurn = true; 
        renderBattleActions();
        toggleButtons(true);
    }
}


function showForcedSwitchPanel(team, callback) {
    switchPanel.style.display = 'flex';
    playerSwitchOptions.innerHTML = '';
    
    document.querySelector('#switch-panel h2').innerText = "必须选择一只宝可梦上场！";

    team.forEach((item, index) => {
        const option = document.createElement('div');
        option.className = 'switch-option';
        
        if (item.isFainted) {
            option.classList.add('fainted-switch');
        } else {
            option.onclick = () => {
                document.querySelector('#switch-panel h2').innerText = "选择要替换上场的宝可梦";
                callback(index);
            };
        }
        
        option.innerHTML = `
            <img src="${item.poke.img}" style="width:50px; height:50px; image-rendering:pixelated;">
            <div>${item.poke.name}</div>
            <div style="font-size:10px;">HP: ${Math.ceil(item.currentHp)}/${item.poke.hp}</div>
        `;
        playerSwitchOptions.appendChild(option);
    });
}


function checkWinCondition() {
    const playerFaintedCount = gameState.playerTeam.filter(i => i.isFainted).length;
    const enemyFaintedCount = gameState.enemyTeam.filter(i => i.isFainted).length;

    if (enemyFaintedCount === gameState.enemyTeam.length) {
        endGame(true); 
        return true;
    }
    if (playerFaintedCount === gameState.playerTeam.length) {
        endGame(false);
        return true;
    }
    return false;
}


function endGame(playerWin) {
    gameState.isGameOver = true;
    toggleButtons(false);

    if (playerWin) {
        log("------------------------------------------");
        log(" ** 恭喜你，你击败了对手！游戏胜利！ ** ");
        log("------------------------------------------");
    } else {
        log("------------------------------------------");
        log(" ** 你的队伍全军覆没... 游戏失败。 ** ");
        log("------------------------------------------");
    }
    
    const restartBtn = document.createElement('button');
    restartBtn.innerText = "重新开始";
    restartBtn.style.width = "100%";
    restartBtn.style.marginTop = "10px";
    restartBtn.onclick = () => location.reload();
    battleActionsContainer.innerHTML = '';
    battleActionsContainer.appendChild(restartBtn);
}


// 启动
init();
</script>
</body>
</html>
